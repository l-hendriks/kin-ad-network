service: kin-ad-network

plugins:
  - serverless-plugin-typescript

provider:
  name: aws
  variableSyntax: \${((env|self|opt|file|cf|s3|ssm|deep)[:\(][ :a-zA-Z0-9'._,\-\/\(\)]*?)}
  runtime: nodejs12.x
  region: eu-central-1
  logRetentionInDays: 14
  profile: kinads
  stage: ${opt:stage, 'dev'}
  environment:
    REGION: ${self:provider.region}
    CLIENT_TABLE_NAME: ${self:provider.stage}-clients
    EVENTS_TABLE_NAME: ${self:provider.stage}-events
    INFO_TABLE_NAME: ${self:provider.stage}-info
    IRONSOURCE_PRIVATE_KEY: ${self:custom.credentials.IRONSOURCE_PRIVATE_KEY}
    IRONSOURCE_SECRET_KEY: ${self:custom.credentials.IRONSOURCE_SECRET_KEY}
    IRONSOURCE_REFRESH_TOKEN: ${self:custom.credentials.IRONSOURCE_REFRESH_TOKEN}
    GOOGLE_CREDENTIALS_JSON:  ${self:custom.credentials.GOOGLE_CREDENTIALS_JSON}
    GOOGLE_SHEET_ID:  ${self:custom.credentials.GOOGLE_SHEET_ID}
  stackPolicy:
    - { Effect: Allow, Principal: "*", Action: "Update:*", Resource: "*"}
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBClientsTable
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBAppsTable
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBAppEventsTable
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBReportsTable
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBEventsTable
    - Effect: Deny
      Principal: "*"
      Action: ["Update:Replace", "Update:Delete"]
      Resource: LogicalResourceId/DynamoDBInfoTable
  iamRoleStatements:
    - Effect: Allow
      Action:
      - dynamodb:Query
      Resource:
        - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBClientsTable", "Arn"] }, "*" ] ] }
    - Effect: Allow
      Action:
      - dynamodb:Query
      - dynamodb:UpdateItem
      Resource:
        - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBEventsTable", "Arn"] }, "*" ] ] }
    - Effect: Allow
      Action:
      - dynamodb:Query
      - dynamodb:UpdateItem
      Resource:
        - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBInfoTable", "Arn"] }, "*" ] ] }

custom:
  credentials: ${ssm:/aws/reference/secretsmanager/${self:provider.stage}~true}
  dev:
    url: "https://dashboard-dev.kinads.org"
  staging:
    url: "https://dashboard-staging.kinads.org"
  production:
    url: "https://dashboard.kinads.org"

functions:
  ironsource_callback:
    handler: handlers/ironsource.default
    timeout: 30
    events:
      - http:
          path: ironsource
          method: get
  reporting:
    handler: handlers/reporting.default
    timeout: 300
    events:
      - schedule: cron(0 18 * * ? *) # Every day at 6:00PM UTC
  info:
    handler: handlers/info.default
    timeout: 30
    events:
      - http:
          path: info
          method: get
  preSignup:
    handler: handlers/preSignup.default
    timeout: 30

resources:
 Resources:
  DynamoDBAppsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-apps
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "userId"
          AttributeType: S
        # mediationId is an overloaded index
        # Mediation index is used for identification and reporting:
        # medationId = type#network#id, with type = reporting|callback
        # So for example:
        # userId|mediationId
        # A     |reporting#ironSource#appId1
        # A     |callback#ironSource#appId1
        # A     |reporting#AdMob#appId1
        # A     |callback#AdMob#adUnit1
        # A     |callback#AdMob#adUnit2
        # A     |callback#AdMob#adUnit3

        # Examples:
        # Callback ironSource:                            query mediationId="callback#ironSource#{appId}"
        # Callback AdMob:                                 query mediationId="callback#AdMob#{adUnitId}"
        # Reporting ironSource:                           query mediationId="reporting#ironSource#{appId}"
        # Reporting AdMob:                                query mediationId="reporting#AdMob#{appId}"
        # Get all reporting mediation networks from user: query userId={userId} AND begins_with(mediationId, 'reporting')
        # Get all AdMob callbacks from user:              query userId={userId} AND begins_with(mediationId, 'callback#AdMob')
        - AttributeName: "mediationId"
          AttributeType: S
      KeySchema:
        - AttributeName: "userId"
          KeyType: HASH
        - AttributeName: "mediationId"
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: mediationIndex
          KeySchema:
          - AttributeName: mediationId
            KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST

  DynamoDBAppsTablePolicyUser:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: DynamoDBAppsTablePolicyUser-${self:provider.stage}
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:Query
            Resource:
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBAppsTable", "Arn"] }, "*" ] ] }
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBAppEventsTable", "Arn"] }, "*" ] ] }
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBReportsTable", "Arn"] }, "*" ] ] }
            Condition: { "ForAllValues:StringEquals": { "dynamodb:LeadingKeys": [ "${cognito-identity.amazonaws.com:sub}" ] } }
      Roles:
        - { "Ref": "UserGroupIdentityRole" }

  DynamoDBAppsTablePolicyAdmin:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: DynamoDBAppsTablePolicyAdmin-${self:provider.stage}
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
            Resource:
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBAppsTable", "Arn"] }, "*" ] ] }
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBAppEventsTable", "Arn"] }, "*" ] ] }
            - { "Fn::Join" : [ "", [ { "Fn::GetAtt": ["DynamoDBReportsTable", "Arn"] }, "*" ] ] }
      Roles:
        - { "Ref": "AdminGroupIdentityRole" }

  DynamoDBAppEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-app-events
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "userId"
          AttributeType: S
        - AttributeName: "eventId"
          AttributeType: S
      KeySchema:
        - AttributeName: "userId"
          KeyType: HASH
        - AttributeName: "eventId"
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true

  DynamoDBReportsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-app-reports
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "userId"
          AttributeType: S
        # dateMedationId is an overloaded index
        # dateMedationId = date#network#id, with date = YYYYMMDD
        # So for example:
        # userId|dateMedationId
        # A     |20201120#ironSource#appId1
        # A     |20201121#ironSource#appId1
        # A     |20201120#AdMob#adUnit1

        # Examples:
        # Get all reporting some month (to date): query userId={userId} AND begins_width(dateMedationId, '202011')
        # Get all reporting of some day: query userId={userId} AND begins_width(dateMedationId, '20201120')
        # Get AdMob reporting information of some day: query userId={userId} AND begins_width(dateMedationId, '20201120#AdMob')
        # Get AdMob reporting information of a particular AdMob ad unit: query userId={userId} AND begins_width(dateMedationId, '20201120#AdMob#adUnit1')
        - AttributeName: "dateMedationId"
          AttributeType: S
      KeySchema:
        - AttributeName: "userId"
          KeyType: HASH
        - AttributeName: "dateMedationId"
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  ##### OLD TABLES, TO BE REMOVED ONCE THE CODEBASE USES THE NEW TABLE STRUCTURE
  DynamoDBClientsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-clients
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "clientId"
          AttributeType: S
      KeySchema:
        - AttributeName: "clientId"
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  DynamoDBEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-events
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "clientId"
          AttributeType: S
        - AttributeName: "eventId"
          AttributeType: S
      KeySchema:
        - AttributeName: "clientId"
          KeyType: HASH
        - AttributeName: "eventId"
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true

  DynamoDBInfoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:provider.stage}-info
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "clientId"
          AttributeType: S
        - AttributeName: "date"
          AttributeType: S
      KeySchema:
        - AttributeName: "clientId"
          KeyType: HASH
        - AttributeName: "date"
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: kin-ads-${self:provider.stage}
      AutoVerifiedAttributes: [email]
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: true
        InviteMessageTemplate:
          EmailSubject: "Kin Ad Network Dashboads"
          EmailMessage: |-
            Username: {username}<br />
            Password: {####}<br /><br  />

            Dashboard url: <a href="${self:custom.${self:provider.stage}.url}" target="_blank">${self:custom.${self:provider.stage}.url}</a>
      LambdaConfig:
        PreSignUp: { "Fn::GetAtt": ["PreSignupLambdaFunction", "Arn"] }
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: False
          RequireUppercase: False
          RequireNumbers: False
          RequireSymbols: False
      Schema:
        - { Name: email, Required: true }

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: kin-ads-${self:provider.stage}
      GenerateSecret: False
      UserPoolId: { "Ref": "UserPool" }

  UserPoolLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: { "Fn::GetAtt": ["PreSignupLambdaFunction", "Arn"] }
      Principal: "cognito-idp.amazonaws.com"
      SourceArn: { "Fn::GetAtt": ["UserPool", "Arn"] }

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: kinads${self:provider.stage}
      AllowUnauthenticatedIdentities: False
      CognitoIdentityProviders:
        - ClientId: { "Ref": "UserPoolClient" }
          ProviderName: {
            "Fn::Join": ["/", ["cognito-idp.${self:provider.region}.amazonaws.com", { "Ref": "UserPool" } ]]
          }

  AdminGroupIdentityRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Federated: cognito-identity.amazonaws.com }
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud": { "Ref": "IdentityPool" }
              "ForAnyValue:StringLike":
                "cognito-identity.amazonaws.com:amr": "authenticated"
      Policies:
        - PolicyName: AdminIdentityPolicy-${self:provider.stage}
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminDeleteUser
                Resource: { "Fn::GetAtt": ["UserPool", "Arn"] }
              - Effect: Allow
                Action:
                  - 'mobileanalytics:PutEvents'
                  - 'cognito-sync:*'
                  - 'cognito-identity:*'
                Resource: '*'

  UserGroupIdentityRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Federated: cognito-identity.amazonaws.com }
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud": { "Ref": "IdentityPool" }
              "ForAnyValue:StringLike":
                "cognito-identity.amazonaws.com:amr": "authenticated"

  UserPoolAdminGroup:
    Type: "AWS::Cognito::UserPoolGroup"
    Properties:
      GroupName: AdminGroup
      Precedence: 1
      RoleArn:  { "Fn::GetAtt": ["AdminGroupIdentityRole", "Arn"] }
      UserPoolId: { "Ref": "UserPool" }

  UserPoolUserGroup:
    Type: "AWS::Cognito::UserPoolGroup"
    Properties:
      GroupName: UserGroup
      Precedence: 1
      RoleArn:  { "Fn::GetAtt": ["UserGroupIdentityRole", "Arn"] }
      UserPoolId: { "Ref": "UserPool" }
